<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>拍點星際旅人 - 音樂節拍遊戲</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Comic Sans MS', 'Microsoft JhengHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0c0b20 0%, #1a1a3a 100%);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            padding: 20px 0 30px;
            position: relative;
        }
        
        .game-title {
            font-size: 3rem;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 15px rgba(78, 205, 196, 0.3);
            margin-bottom: 10px;
            letter-spacing: 2px;
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: #a5b4fc;
            margin-bottom: 20px;
        }
        
        .game-description {
            max-width: 800px;
            margin: 0 auto 30px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            border-left: 5px solid #4ecdc4;
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        
        .game-area {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
        }
        
        .control-panel {
            flex: 1;
            min-width: 300px;
            background-color: rgba(30, 30, 60, 0.8);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            border: 2px solid #4ecdc4;
        }
        
        .game-screen {
            flex: 2;
            min-width: 600px;
            background-color: rgba(10, 10, 30, 0.9);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
            min-height: 600px;
            display: flex;
            flex-direction: column;
        }
        
        .panel-title {
            font-size: 1.8rem;
            color: #4ecdc4;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 2px solid #4ecdc4;
            padding-bottom: 10px;
        }
        
        .level-selector {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .level-btn {
            background-color: #2a2a5a;
            border: none;
            border-radius: 12px;
            padding: 15px;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .level-btn:hover {
            background-color: #3a3a7a;
            transform: translateY(-3px);
        }
        
        .level-btn.active {
            background: linear-gradient(90deg, #4ecdc4, #44a7d1);
            box-shadow: 0 0 15px rgba(78, 205, 196, 0.5);
        }
        
        .level-icon {
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }
        
        .game-info {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .info-title {
            color: #ffd166;
            font-size: 1.3rem;
            margin-bottom: 10px;
        }
        
        .info-content {
            line-height: 1.6;
            color: #cbd5e1;
        }
        
        .stats {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .stat-item {
            text-align: center;
            flex: 1;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #4ecdc4;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #a5b4fc;
        }
        
        /* 遊戲畫面樣式 */
        .game-screen-title {
            text-align: center;
            font-size: 2rem;
            color: #ffd166;
            margin-bottom: 20px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .game-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        /* 第一關：星軌辨識師 */
        .planet-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin-bottom: 30px;
        }
        
        .planet {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.2);
            background: radial-gradient(circle at 30% 30%, #ff9a76, #ff6b6b);
            transition: all 0.5s ease;
        }
        
        .beat-orbit {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px dashed rgba(255, 255, 255, 0.3);
        }
        
        .beat-point {
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #4ecdc4;
            box-shadow: 0 0 15px #4ecdc4;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            transition: all 0.3s ease;
        }
        
        .beat-point.strong {
            background-color: #ff6b6b;
            box-shadow: 0 0 20px #ff6b6b;
            width: 40px;
            height: 40px;
        }
        
        .beat-label {
            position: absolute;
            font-size: 1.2rem;
            font-weight: bold;
            color: white;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .beat-options {
            display: flex;
            gap: 30px;
            margin-top: 20px;
        }
        
        .beat-option {
            padding: 15px 30px;
            background-color: #2a2a5a;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.3rem;
            transition: all 0.3s ease;
            text-align: center;
            min-width: 150px;
        }
        
        .beat-option:hover {
            background-color: #3a3a7a;
            transform: scale(1.05);
        }
        
        .beat-option.selected {
            background-color: #4ecdc4;
            box-shadow: 0 0 15px rgba(78, 205, 196, 0.7);
        }
        
        /* 第二關：能量採集員 */
        .rhythm-river {
            width: 100%;
            height: 120px;
            background: linear-gradient(90deg, #1a237e, #283593, #3949ab);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            margin-bottom: 30px;
            border: 3px solid #4ecdc4;
        }
        
        .rhythm-block {
            position: absolute;
            height: 80px;
            border-radius: 8px;
            top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3);
            transition: left 0.05s linear;
        }
        
        .rhythm-block.ta {
            width: 80px;
            background-color: #ff6b6b;
        }
        
        .rhythm-block.ti-ti {
            width: 160px;
            background-color: #4ecdc4;
            display: flex;
            justify-content: space-around;
        }
        
        .rhythm-block.rest {
            width: 80px;
            background-color: #555;
            border: 2px dashed #aaa;
        }
        
        .collection-zone {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 30px;
        }
        
        .collection-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }
        
        .strong-btn {
            background-color: #ff6b6b;
            border: 5px solid #ff9a76;
        }
        
        .weak-btn {
            background-color: #4ecdc4;
            border: 5px solid #8de4df;
        }
        
        .collection-btn.active {
            transform: scale(1.2);
            box-shadow: 0 0 25px currentColor;
        }
        
        /* 第三關：星球修復師 */
        .planet-repair {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }
        
        .repair-orbit {
            width: 400px;
            height: 120px;
            background-color: rgba(30, 30, 70, 0.7);
            border-radius: 60px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding: 0 30px;
            border: 3px solid #4ecdc4;
            position: relative;
        }
        
        .orbit-slot {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.05);
            border: 2px dashed rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: rgba(255, 255, 255, 0.3);
        }
        
        .orbit-slot.filled {
            border: none;
            background-color: transparent;
        }
        
        .rhythm-palette {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .palette-block {
            width: 100px;
            height: 100px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            cursor: grab;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }
        
        .palette-block:active {
            cursor: grabbing;
        }
        
        /* 第四關：小步舞曲星雲 */
        .music-cloud {
            width: 100%;
            height: 400px;
            position: relative;
            overflow: hidden;
            border-radius: 15px;
            background: radial-gradient(circle at center, #1a237e, #0c0b20);
        }
        
        .music-particle {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 70%);
            opacity: 0.7;
        }
        
        .music-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }
        
        .music-btn {
            padding: 15px 30px;
            background-color: #4ecdc4;
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .music-btn:hover {
            background-color: #3dbdb4;
            transform: translateY(-3px);
        }
        
        /* 反饋訊息 */
        .feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 30px 50px;
            border-radius: 20px;
            font-size: 2rem;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
            animation: fadeInOut 2s forwards;
            display: none;
        }
        
        .feedback.correct {
            background-color: rgba(78, 205, 196, 0.9);
            color: #0c0b20;
        }
        
        .feedback.incorrect {
            background-color: rgba(255, 107, 107, 0.9);
            color: white;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            40% { transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        .stars {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .star {
            position: absolute;
            background-color: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: #a5b4fc;
            font-size: 0.9rem;
        }
        
        .progress-bar {
            height: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ecdc4, #44a7d1);
            border-radius: 5px;
            width: 0%;
            transition: width 0.5s ease;
        }
        
        /* 響應式設計 */
        @media (max-width: 1100px) {
            .game-area {
                flex-direction: column;
            }
            
            .game-screen {
                min-width: 100%;
            }
            
            .control-panel {
                min-width: 100%;
            }
        }
        
        @media (max-width: 768px) {
            .game-title {
                font-size: 2.2rem;
            }
            
            .game-screen {
                min-height: 500px;
                padding: 15px;
            }
            
            .planet-container {
                width: 250px;
                height: 250px;
            }
            
            .repair-orbit {
                width: 100%;
                max-width: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="game-title">拍點星際旅人</h1>
            <p class="subtitle">視覺化音樂節拍學習遊戲 - 二年級音樂單元：笑笑又唱唱</p>
            
            <div class="game-description">
                <p>歡迎來到《拍點星際旅人》！在這個遊戲中，你將通過四個視覺化關卡學習二拍子和三拍子的節奏。</p>
                <p>遊戲對應單元教學目標：辨別二、三拍子節奏、發展歌唱技巧、創作節奏，並培養創造力與合作精神。</p>
            </div>
        </div>
        
        <div class="main-content">
            <div class="game-area">
                <div class="control-panel">
                    <h2 class="panel-title">遊戲關卡</h2>
                    
                    <div class="level-selector">
                        <button class="level-btn active" data-level="1">
                            <div class="level-icon"><i class="fas fa-globe-asia"></i></div>
                            <div class="level-text">
                                <div class="level-name">第一關：星軌辨識師</div>
                                <div class="level-desc">辨別二拍子與三拍子</div>
                            </div>
                        </button>
                        
                        <button class="level-btn" data-level="2">
                            <div class="level-icon"><i class="fas fa-water"></i></div>
                            <div class="level-text">
                                <div class="level-name">第二關：能量採集員</div>
                                <div class="level-desc">律動與拍打節奏</div>
                            </div>
                        </button>
                        
                        <button class="level-btn" data-level="3">
                            <div class="level-icon"><i class="fas fa-tools"></i></div>
                            <div class="level-text">
                                <div class="level-name">第三關：星球修復師</div>
                                <div class="level-desc">創作三拍子節奏</div>
                            </div>
                        </button>
                        
                        <button class="level-btn" data-level="4">
                            <div class="level-icon"><i class="fas fa-cloud-music"></i></div>
                            <div class="level-text">
                                <div class="level-name">第四關：小步舞曲星雲</div>
                                <div class="level-desc">聆聽與辨識經典樂曲</div>
                            </div>
                        </button>
                    </div>
                    
                    <div class="game-info">
                        <h3 class="info-title">遊戲說明</h3>
                        <div class="info-content" id="level-description">
                            觀察星球的節拍軌道，當光點沿軌道運行時，注意強拍（大亮點）和弱拍（小亮點）的出現模式，選擇正確的拍子類型。
                        </div>
                    </div>
                    
                    <div class="stats">
                        <div class="stat-item">
                            <div class="stat-value" id="score">0</div>
                            <div class="stat-label">得分</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="level">1/4</div>
                            <div class="stat-label">關卡</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="stars">0</div>
                            <div class="stat-label">星星</div>
                        </div>
                    </div>
                </div>
                
                <div class="game-screen">
                    <div class="game-screen-title" id="game-title">第一關：星軌辨識師</div>
                    
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill" style="width: 25%"></div>
                    </div>
                    
                    <div class="game-content">
                        <!-- 第一關內容 -->
                        <div id="level-1-content" class="level-content">
                            <div class="planet-container">
                                <div class="beat-orbit" id="beat-orbit"></div>
                                <div class="planet" id="planet"></div>
                                <div class="beat-point" id="beat-point"></div>
                            </div>
                            
                            <div class="beat-options">
                                <div class="beat-option" data-beat="2">咚嚓星球<br>二拍子</div>
                                <div class="beat-option" data-beat="3">咚嚓嚓星球<br>三拍子</div>
                            </div>
                            
                            <button id="play-beat" class="music-btn" style="margin-top: 30px;">播放節拍</button>
                        </div>
                        
                        <!-- 第二關內容 -->
                        <div id="level-2-content" class="level-content" style="display: none;">
                            <div class="rhythm-river" id="rhythm-river">
                                <!-- 節奏塊會由JavaScript動態生成 -->
                            </div>
                            
                            <div class="collection-zone">
                                <div class="collection-btn strong-btn" data-type="strong">
                                    <i class="fas fa-drum"></i>
                                </div>
                                <div class="collection-btn weak-btn" data-type="weak">
                                    <i class="fas fa-drum-steelpan"></i>
                                </div>
                            </div>
                            
                            <div style="margin-top: 30px; text-align: center;">
                                <p>跟隨節奏河的節奏塊，在強拍和弱拍時點擊對應的鼓</p>
                                <button id="start-rhythm" class="music-btn">開始節奏練習</button>
                            </div>
                        </div>
                        
                        <!-- 第三關內容 -->
                        <div id="level-3-content" class="level-content" style="display: none;">
                            <div class="planet-repair">
                                <div class="repair-orbit">
                                    <div class="orbit-slot" id="slot-1">1</div>
                                    <div class="orbit-slot" id="slot-2">2</div>
                                    <div class="orbit-slot" id="slot-3">3</div>
                                </div>
                                
                                <div class="rhythm-palette">
                                    <div class="palette-block ta" style="background-color: #ff6b6b;" data-type="ta">Ta</div>
                                    <div class="palette-block ti-ti" style="background-color: #4ecdc4;" data-type="ti-ti">Ti-Ti</div>
                                    <div class="palette-block rest" style="background-color: #555;" data-type="rest">休止</div>
                                </div>
                                
                                <div style="display: flex; gap: 15px; margin-top: 20px;">
                                    <button id="play-rhythm" class="music-btn">播放節奏</button>
                                    <button id="clear-rhythm" class="music-btn" style="background-color: #ff6b6b;">清除</button>
                                    <button id="check-rhythm" class="music-btn" style="background-color: #ffd166;">檢查</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 第四關內容 -->
                        <div id="level-4-content" class="level-content" style="display: none;">
                            <div class="music-cloud" id="music-cloud">
                                <!-- 音樂粒子會由JavaScript動態生成 -->
                            </div>
                            
                            <div class="music-controls">
                                <button id="play-music" class="music-btn">播放音樂</button>
                                <button id="pause-music" class="music-btn" style="background-color: #ff6b6b;">暫停</button>
                            </div>
                            
                            <div style="margin-top: 30px; text-align: center;">
                                <p>聆聽音樂並觀察星雲的變化，然後回答問題：</p>
                                <p style="margin: 15px 0; font-size: 1.3rem;">這首音樂是幾拍子的？</p>
                                
                                <div class="beat-options">
                                    <div class="beat-option music-answer" data-beat="2">二拍子</div>
                                    <div class="beat-option music-answer" data-beat="3">三拍子</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>《拍點星際旅人》遊戲對應「單元一：笑笑又唱唱」教學計劃 - 二年級下學期音樂課程</p>
            <p>培養學生：創造力 · 批判性思考 · 協作能力 · 音樂興趣 · 合作精神</p>
        </div>
    </div>
    
    <!-- 反饋訊息 -->
    <div class="feedback correct" id="correct-feedback">正確！</div>
    <div class="feedback incorrect" id="incorrect-feedback">再試試看！</div>
    
    <!-- 背景星星 -->
    <div class="stars" id="stars-bg"></div>
    
    <script>
        // 遊戲狀態
        const gameState = {
            currentLevel: 1,
            score: 0,
            stars: 0,
            progress: 25,
            levelDescriptions: [
                "觀察星球的節拍軌道，當光點沿軌道運行時，注意強拍（大亮點）和弱拍（小亮點）的出現模式，選擇正確的拍子類型。",
                "節奏河中的方塊代表不同的節奏型：紅色長方塊是Ta（一拍），青色雙方塊是Ti-Ti（兩個半拍），灰色方塊是休止。跟隨節奏點擊對應的鼓。",
                "從下方的節奏積木中拖放到星球軌道的三個空位上，創作一個三拍子節奏。完成後可以播放和檢查你的創作。",
                "聆聽《G大調小步舞曲》並觀察星雲的視覺化表現，判斷這首樂曲是二拍子還是三拍子。"
            ]
        };
        
        // DOM元素
        const levelButtons = document.querySelectorAll('.level-btn');
        const levelContents = document.querySelectorAll('.level-content');
        const gameTitle = document.getElementById('game-title');
        const levelDescription = document.getElementById('level-description');
        const scoreElement = document.getElementById('score');
        const levelElement = document.getElementById('level');
        const starsElement = document.getElementById('stars');
        const progressFill = document.getElementById('progress-fill');
        const correctFeedback = document.getElementById('correct-feedback');
        const incorrectFeedback = document.getElementById('incorrect-feedback');
        
        // 第一關元素
        const beatOrbit = document.getElementById('beat-orbit');
        const planet = document.getElementById('planet');
        const beatPoint = document.getElementById('beat-point');
        const beatOptions = document.querySelectorAll('.beat-option');
        const playBeatButton = document.getElementById('play-beat');
        
        // 第二關元素
        const rhythmRiver = document.getElementById('rhythm-river');
        const collectionButtons = document.querySelectorAll('.collection-btn');
        const startRhythmButton = document.getElementById('start-rhythm');
        
        // 第三關元素
        const orbitSlots = document.querySelectorAll('.orbit-slot');
        const paletteBlocks = document.querySelectorAll('.palette-block');
        const playRhythmButton = document.getElementById('play-rhythm');
        const clearRhythmButton = document.getElementById('clear-rhythm');
        const checkRhythmButton = document.getElementById('check-rhythm');
        
        // 第四關元素
        const musicCloud = document.getElementById('music-cloud');
        const playMusicButton = document.getElementById('play-music');
        const pauseMusicButton = document.getElementById('pause-music');
        const musicAnswers = document.querySelectorAll('.music-answer');
        
        // 遊戲變量
        let currentBeatPattern = 0;
        let isPlayingBeat = false;
        let isRhythmGameActive = false;
        let rhythmBlocks = [];
        let rhythmSequence = [];
        let currentRhythmIndex = 0;
        let slotContents = [null, null, null];
        let musicParticles = [];
        let isMusicPlaying = false;
        
        // 初始化遊戲
        function initGame() {
            createStars();
            updateGameInfo();
            setupLevel1();
            setupEventListeners();
        }
        
        // 創建背景星星
        function createStars() {
            const starsBg = document.getElementById('stars-bg');
            for (let i = 0; i < 150; i++) {
                const star = document.createElement('div');
                star.classList.add('star');
                
                const size = Math.random() * 3 + 1;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * 100}%`;
                
                star.style.animationDelay = `${Math.random() * 3}s`;
                
                starsBg.appendChild(star);
            }
        }
        
        // 設置事件監聽器
        function setupEventListeners() {
            // 關卡選擇按鈕
            levelButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const level = parseInt(this.getAttribute('data-level'));
                    switchLevel(level);
                });
            });
            
            // 第一關事件
            beatOptions.forEach(option => {
                option.addEventListener('click', function() {
                    if (isPlayingBeat) return;
                    
                    beatOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    
                    const selectedBeat = parseInt(this.getAttribute('data-beat'));
                    checkBeatAnswer(selectedBeat);
                });
            });
            
            playBeatButton.addEventListener('click', playBeatPattern);
            
            // 第二關事件
            collectionButtons.forEach(button => {
                button.addEventListener('click', function() {
                    if (!isRhythmGameActive) return;
                    
                    const type = this.getAttribute('data-type');
                    checkRhythmInput(type);
                });
            });
            
            startRhythmButton.addEventListener('click', startRhythmGame);
            
            // 第三關事件
            paletteBlocks.forEach(block => {
                block.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', this.getAttribute('data-type'));
                });
            });
            
            orbitSlots.forEach((slot, index) => {
                slot.addEventListener('dragover', function(e) {
                    e.preventDefault();
                });
                
                slot.addEventListener('drop', function(e) {
                    e.preventDefault();
                    const type = e.dataTransfer.getData('text/plain');
                    placeRhythmBlock(index, type);
                });
            });
            
            playRhythmButton.addEventListener('click', playCreatedRhythm);
            clearRhythmButton.addEventListener('click', clearCreatedRhythm);
            checkRhythmButton.addEventListener('click', checkCreatedRhythm);
            
            // 第四關事件
            playMusicButton.addEventListener('click', playMusicVisualization);
            pauseMusicButton.addEventListener('click', pauseMusicVisualization);
            
            musicAnswers.forEach(answer => {
                answer.addEventListener('click', function() {
                    const selectedBeat = parseInt(this.getAttribute('data-beat'));
                    checkMusicAnswer(selectedBeat);
                });
            });
        }
        
        // 切換關卡
        function switchLevel(level) {
            gameState.currentLevel = level;
            
            // 更新按鈕狀態
            levelButtons.forEach(button => {
                const btnLevel = parseInt(button.getAttribute('data-level'));
                if (btnLevel === level) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
            
            // 更新標題
            const levelTitles = [
                "第一關：星軌辨識師",
                "第二關：能量採集員",
                "第三關：星球修復師",
                "第四關：小步舞曲星雲"
            ];
            gameTitle.textContent = levelTitles[level - 1];
            
            // 更新說明
            levelDescription.textContent = gameState.levelDescriptions[level - 1];
            
            // 更新進度條
            gameState.progress = level * 25;
            progressFill.style.width = `${gameState.progress}%`;
            
            // 更新關卡顯示
            levelElement.textContent = `${level}/4`;
            
            // 顯示對應關卡內容
            levelContents.forEach(content => {
                content.style.display = 'none';
            });
            
            document.getElementById(`level-${level}-content`).style.display = 'block';
            
            // 初始化關卡
            switch(level) {
                case 1:
                    setupLevel1();
                    break;
                case 2:
                    setupLevel2();
                    break;
                case 3:
                    setupLevel3();
                    break;
                case 4:
                    setupLevel4();
                    break;
            }
        }
        
        // 更新遊戲資訊
        function updateGameInfo() {
            scoreElement.textContent = gameState.score;
            starsElement.textContent = gameState.stars;
        }
        
        // 顯示反饋訊息
        function showFeedback(isCorrect) {
            if (isCorrect) {
                correctFeedback.style.display = 'block';
                setTimeout(() => {
                    correctFeedback.style.display = 'none';
                }, 2000);
            } else {
                incorrectFeedback.style.display = 'block';
                setTimeout(() => {
                    incorrectFeedback.style.display = 'none';
                }, 2000);
            }
        }
        
        // ==================== 第一關：星軌辨識師 ====================
        function setupLevel1() {
            // 重置選擇
            beatOptions.forEach(opt => opt.classList.remove('selected'));
            
            // 隨機選擇一個拍子模式 (2 或 3)
            currentBeatPattern = Math.random() < 0.5 ? 2 : 3;
            
            // 設置星球顏色
            if (currentBeatPattern === 2) {
                planet.style.background = "radial-gradient(circle at 30% 30%, #ff9a76, #ff6b6b)";
            } else {
                planet.style.background = "radial-gradient(circle at 30% 30%, #4ecdc4, #44a7d1)";
            }
            
            // 重置節拍點位置
            beatPoint.style.transform = "translateX(-50%) rotate(0deg)";
            beatPoint.classList.remove('strong');
            
            isPlayingBeat = false;
        }
        
        function playBeatPattern() {
            if (isPlayingBeat) return;
            
            isPlayingBeat = true;
            playBeatButton.disabled = true;
            
            // 設置軌道上的節拍點數量
            beatOrbit.innerHTML = '';
            const radius = 150;
            
            for (let i = 0; i < currentBeatPattern; i++) {
                const angle = (i / currentBeatPattern) * 2 * Math.PI;
                const x = radius * Math.cos(angle - Math.PI/2);
                const y = radius * Math.sin(angle - Math.PI/2);
                
                const point = document.createElement('div');
                point.classList.add('beat-point');
                point.style.left = `calc(50% + ${x}px)`;
                point.style.top = `calc(50% + ${y}px)`;
                
                if (i === 0) {
                    point.classList.add('strong');
                }
                
                beatOrbit.appendChild(point);
            }
            
            // 動畫：旋轉節拍點
            let rotation = 0;
            const totalRotation = 720; // 旋轉兩圈
            const duration = 3000; // 3秒
            const interval = 10;
            const steps = duration / interval;
            const rotationPerStep = totalRotation / steps;
            
            let step = 0;
            const animation = setInterval(() => {
                rotation += rotationPerStep;
                beatPoint.style.transform = `translateX(-50%) rotate(${rotation}deg)`;
                
                // 改變節拍點大小來模擬強弱拍
                const pulseSize = Math.sin(step * 0.5) * 5 + 30;
                beatPoint.style.width = `${pulseSize}px`;
                beatPoint.style.height = `${pulseSize}px`;
                
                step++;
                
                if (step >= steps) {
                    clearInterval(animation);
                    isPlayingBeat = false;
                    playBeatButton.disabled = false;
                    
                    // 顯示答案提示
                    setTimeout(() => {
                        if (currentBeatPattern === 2) {
                            beatOptions[0].style.backgroundColor = "#4ecdc4";
                            beatOptions[0].style.boxShadow = "0 0 15px rgba(78, 205, 196, 0.7)";
                        } else {
                            beatOptions[1].style.backgroundColor = "#4ecdc4";
                            beatOptions[1].style.boxShadow = "0 0 15px rgba(78, 205, 196, 0.7)";
                        }
                    }, 1000);
                }
            }, interval);
        }
        
        function checkBeatAnswer(selectedBeat) {
            const isCorrect = selectedBeat === currentBeatPattern;
            
            if (isCorrect) {
                gameState.score += 100;
                gameState.stars += 1;
                showFeedback(true);
                
                // 延遲後自動進入下一關
                setTimeout(() => {
                    if (gameState.currentLevel < 4) {
                        switchLevel(gameState.currentLevel + 1);
                    }
                }, 1500);
            } else {
                showFeedback(false);
            }
            
            updateGameInfo();
        }
        
        // ==================== 第二關：能量採集員 ====================
        function setupLevel2() {
            // 清除節奏河
            rhythmRiver.innerHTML = '';
            rhythmBlocks = [];
            rhythmSequence = [];
            currentRhythmIndex = 0;
            isRhythmGameActive = false;
            
            // 生成節奏模式
            const patterns = [
                ['ta', 'rest', 'ti-ti'],
                ['ti-ti', 'ta', 'ta'],
                ['ta', 'ti-ti', 'rest']
            ];
            
            const pattern = patterns[Math.floor(Math.random() * patterns.length)];
            
            // 創建節奏塊
            let position = 50;
            pattern.forEach((type, index) => {
                const block = document.createElement('div');
                block.classList.add('rhythm-block', type);
                
                if (type === 'ti-ti') {
                    block.innerHTML = '<div>Ti</div><div>Ti</div>';
                } else if (type === 'ta') {
                    block.textContent = 'Ta';
                } else {
                    block.textContent = '~';
                }
                
                block.style.left = `${position}px`;
                rhythmRiver.appendChild(block);
                
                rhythmBlocks.push({
                    element: block,
                    type: type,
                    position: position,
                    collected: false
                });
                
                // 為每個節奏塊生成節奏序列
                if (type === 'ta') {
                    rhythmSequence.push('strong');
                } else if (type === 'ti-ti') {
                    rhythmSequence.push('strong');
                    rhythmSequence.push('weak');
                } else if (type === 'rest') {
                    rhythmSequence.push(null);
                }
                
                position += 180;
            });
        }
        
        function startRhythmGame() {
            isRhythmGameActive = true;
            startRhythmButton.disabled = true;
            currentRhythmIndex = 0;
            
            // 移動節奏塊
            let animationId;
            let startTime = null;
            
            function animateBlocks(timestamp) {
                if (!startTime) startTime = timestamp;
                const elapsed = timestamp - startTime;
                
                // 移動節奏塊
                rhythmBlocks.forEach(block => {
                    const newPosition = block.position - (elapsed * 0.05);
                    block.element.style.left = `${newPosition}px`;
                    
                    // 如果節奏塊到達採集區域
                    if (newPosition < 150 && newPosition > 50 && !block.collected) {
                        block.element.style.boxShadow = '0 0 20px #ffd166';
                    }
                });
                
                // 檢查遊戲是否結束
                if (rhythmBlocks.every(block => parseFloat(block.element.style.left) < -200)) {
                    isRhythmGameActive = false;
                    startRhythmButton.disabled = false;
                    
                    // 計算分數
                    const correctCount = rhythmBlocks.filter(block => block.collected).length;
                    if (correctCount === rhythmBlocks.length) {
                        gameState.score += 150;
                        gameState.stars += 1;
                        showFeedback(true);
                        
                        // 延遲後自動進入下一關
                        setTimeout(() => {
                            if (gameState.currentLevel < 4) {
                                switchLevel(gameState.currentLevel + 1);
                            }
                        }, 1500);
                    } else {
                        showFeedback(false);
                    }
                    
                    updateGameInfo();
                    return;
                }
                
                animationId = requestAnimationFrame(animateBlocks);
            }
            
            animationId = requestAnimationFrame(animateBlocks);
            
            // 10秒後自動停止
            setTimeout(() => {
                if (isRhythmGameActive) {
                    isRhythmGameActive = false;
                    startRhythmButton.disabled = false;
                    cancelAnimationFrame(animationId);
                    showFeedback(false);
                }
            }, 10000);
        }
        
        function checkRhythmInput(type) {
            if (!isRhythmGameActive || currentRhythmIndex >= rhythmSequence.length) return;
            
            const expectedType = rhythmSequence[currentRhythmIndex];
            
            if (expectedType === type) {
                // 正確
                collectionButtons.forEach(btn => {
                    if (btn.getAttribute('data-type') === type) {
                        btn.classList.add('active');
                        setTimeout(() => btn.classList.remove('active'), 300);
                    }
                });
                
                currentRhythmIndex++;
                
                // 如果處理完一個節奏塊，標記為已收集
                if (expectedType === 'strong' && rhythmSequence[currentRhythmIndex] !== 'weak') {
                    const blockIndex = Math.floor(currentRhythmIndex / 2);
                    if (blockIndex < rhythmBlocks.length) {
                        rhythmBlocks[blockIndex].collected = true;
                        rhythmBlocks[blockIndex].element.style.opacity = '0.5';
                    }
                }
            } else {
                // 錯誤
                showFeedback(false);
            }
        }
        
        // ==================== 第三關：星球修復師 ====================
        function setupLevel3() {
            // 重置軌道槽
            orbitSlots.forEach(slot => {
                slot.classList.remove('filled');
                slot.innerHTML = slot.id.replace('slot-', '');
                slot.style.background = "rgba(255, 255, 255, 0.05)";
                slot.style.border = "2px dashed rgba(255, 255, 255, 0.2)";
            });
            
            slotContents = [null, null, null];
        }
        
        function placeRhythmBlock(slotIndex, type) {
            const slot = orbitSlots[slotIndex];
            
            // 更新槽內容
            slotContents[slotIndex] = type;
            slot.classList.add('filled');
            
            // 設置槽的外觀
            if (type === 'ta') {
                slot.style.background = "#ff6b6b";
                slot.textContent = "Ta";
            } else if (type === 'ti-ti') {
                slot.style.background = "#4ecdc4";
                slot.textContent = "Ti-Ti";
            } else if (type === 'rest') {
                slot.style.background = "#555";
                slot.textContent = "~";
                slot.style.border = "2px dashed #aaa";
            }
        }
        
        function playCreatedRhythm() {
            // 檢查是否有節奏
            if (slotContents.every(slot => slot === null)) {
                showFeedback(false);
                return;
            }
            
            // 創建一個簡單的節奏播放器
            let index = 0;
            
            function playNext() {
                if (index >= 3) return;
                
                const slot = orbitSlots[index];
                const type = slotContents[index];
                
                // 高亮當前槽
                orbitSlots.forEach(s => s.style.boxShadow = 'none');
                slot.style.boxShadow = '0 0 20px #ffd166';
                
                // 播放對應音效（這裡用視覺效果代替）
                if (type === 'ta') {
                    slot.style.transform = 'scale(1.2)';
                    setTimeout(() => {
                        slot.style.transform = 'scale(1)';
                    }, 300);
                } else if (type === 'ti-ti') {
                    // 播放兩次
                    let count = 0;
                    const pulse = setInterval(() => {
                        slot.style.transform = 'scale(1.2)';
                        setTimeout(() => {
                            slot.style.transform = 'scale(1)';
                        }, 150);
                        
                        count++;
                        if (count >= 2) {
                            clearInterval(pulse);
                        }
                    }, 300);
                }
                
                index++;
                setTimeout(playNext, 1000);
            }
            
            playNext();
        }
        
        function clearCreatedRhythm() {
            setupLevel3();
        }
        
        function checkCreatedRhythm() {
            // 檢查是否三個槽都已填滿
            if (slotContents.some(slot => slot === null)) {
                showFeedback(false);
                return;
            }
            
            // 簡單檢查：至少有一個ta或ti-ti
            const hasNote = slotContents.some(slot => slot === 'ta' || slot === 'ti-ti');
            
            if (hasNote) {
                gameState.score += 200;
                gameState.stars += 2;
                showFeedback(true);
                updateGameInfo();
                
                // 延遲後自動進入下一關
                setTimeout(() => {
                    if (gameState.currentLevel < 4) {
                        switchLevel(gameState.currentLevel + 1);
                    }
                }, 1500);
            } else {
                showFeedback(false);
            }
        }
        
        // ==================== 第四關：小步舞曲星雲 ====================
        function setupLevel4() {
            // 清除星雲
            musicCloud.innerHTML = '';
            musicParticles = [];
            isMusicPlaying = false;
            
            // 創建音樂粒子
            for (let i = 0; i < 50; i++) {
                createMusicParticle();
            }
        }
        
        function createMusicParticle() {
            const particle = document.createElement('div');
            particle.classList.add('music-particle');
            
            const size = Math.random() * 20 + 5;
            particle.style.width = `${size}px`;
            particle.style.height = `${size}px`;
            
            particle.style.left = `${Math.random() * 100}%`;
            particle.style.top = `${Math.random() * 100}%`;
            
            musicCloud.appendChild(particle);
            musicParticles.push({
                element: particle,
                x: Math.random() * 100,
                y: Math.random() * 100,
                speedX: (Math.random() - 0.5) * 0.5,
                speedY: (Math.random() - 0.5) * 0.5,
                pulseSpeed: Math.random() * 0.02 + 0.01,
                pulsePhase: Math.random() * Math.PI * 2
            });
        }
        
        function playMusicVisualization() {
            if (isMusicPlaying) return;
            
            isMusicPlaying = true;
            
            // 設置正確答案（小步舞曲是三拍子）
            const correctAnswer = 3;
            
            // 動畫粒子
            let animationId;
            
            function animateParticles() {
                musicParticles.forEach(particle => {
                    // 更新位置
                    particle.x += particle.speedX;
                    particle.y += particle.speedY;
                    
                    // 邊界檢查
                    if (particle.x < 0 || particle.x > 100) particle.speedX *= -1;
                    if (particle.y < 0 || particle.y > 100) particle.speedY *= -1;
                    
                    // 脈衝效果
                    particle.pulsePhase += particle.pulseSpeed;
                    const scale = 0.5 + 0.5 * Math.sin(particle.pulsePhase);
                    
                    // 應用變換
                    particle.element.style.left = `${particle.x}%`;
                    particle.element.style.top = `${particle.y}%`;
                    particle.element.style.transform = `scale(${scale})`;
                    
                    // 三拍子模式：每三拍改變一次顏色
                    const colorPhase = (particle.pulsePhase * 3) % (Math.PI * 2);
                    const r = Math.floor(100 + 155 * Math.sin(colorPhase));
                    const g = Math.floor(100 + 155 * Math.sin(colorPhase + Math.PI/2));
                    const b = Math.floor(100 + 155 * Math.sin(colorPhase + Math.PI));
                    
                    particle.element.style.background = `radial-gradient(circle, rgba(${r},${g},${b},0.8) 0%, rgba(255,255,255,0) 70%)`;
                });
                
                if (isMusicPlaying) {
                    animationId = requestAnimationFrame(animateParticles);
                }
            }
            
            animateParticles();
            
            // 30秒後自動停止
            setTimeout(() => {
                if (isMusicPlaying) {
                    pauseMusicVisualization();
                }
            }, 30000);
        }
        
        function pauseMusicVisualization() {
            isMusicPlaying = false;
        }
        
        function checkMusicAnswer(selectedBeat) {
            // 正確答案是3（小步舞曲是三拍子）
            const isCorrect = selectedBeat === 3;
            
            if (isCorrect) {
                gameState.score += 250;
                gameState.stars += 3;
                showFeedback(true);
                
                // 遊戲完成
                setTimeout(() => {
                    alert(`恭喜你完成了所有關卡！\n總得分：${gameState.score}\n獲得星星：${gameState.stars}`);
                    // 可以重置遊戲或進入下一輪
                }, 1500);
            } else {
                showFeedback(false);
            }
            
            updateGameInfo();
        }
        
        // 初始化遊戲
        window.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
